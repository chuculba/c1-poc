<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
	xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf">

	<cxf:cxfEndpoint id="addressEndpoint" address="http://localhost:8185/address"
		serviceClass="org.poc.ws.AddressEndpoint" xmlns:ns="suncorp-com-au:schema:enterprise:getaddress:2012:05" />

	<bean id="aggregateResponseStrategy" class="org.poc.transformer.AggregateResponseStrategy" />


	<camelContext id="address-service-context"
		xmlns="http://camel.apache.org/schema/blueprint">
		<route id="addressRoute">
			<from uri="cxf:bean:addressEndpoint?dataFormat=MESSAGE" />
			<convertBodyTo type="java.lang.String"/>			
			<log message="Incoming message ${body}" />
			<split streaming="true" strategyRef="aggregateResponseStrategy">
				<tokenize token="Product" xml="true" inheritNamespaceTagName="GetAddressRequest" />
				<to uri="direct:serviceChoice" />
			</split>
			<transform>
				<simple>&lt;root&gt;${body}&lt;&#47;root&gt;</simple>
			</transform>		
			<log message="Outgoing message before transform ${body}" />			
			<to uri="xslt:xsl/ConsumerResponseTransform.xsl" />
			<log message="Outgoing message ${body}" />
		</route>
		
		<route id="serviceChoiceRoute">
			<from uri="direct:serviceChoice" />
			<log message="Product ${body}" />
			<choice>
				<when>
					<xpath>//*:SystemID/text() = 'AAA'</xpath>
					<to uri="direct:serviceAAA" />
				</when>
				<when>
					<xpath>//*:SystemID/text() = 'BBB'</xpath>
					<to uri="direct:serviceBBB" />
				</when>
				<when>
					<xpath>//*:SystemID/text() = 'CCC'</xpath>
					<to uri="direct:serviceCCC" />
				</when>
			</choice>
		</route>

		<route customId="true" id="serviceAAA">
			<from uri="direct:serviceAAA" />
			<log message="Service AAA ${body}" />
			<!-- TODO Active MQ/WMQ -->
		</route>

		<route customId="true" id="serviceBBB">
			<from uri="direct:serviceBBB" />
			<to uri="xslt:xsl/BBBRequestTransform.xsl" />		
			<!-- NEED TO AGGREGATE HERE AND SEND ONE MESSAGE BASED ON MESSAGE ID -->
			<to	uri="cxf:http://localhost:8186/BBB?wsdlURL=wsdl/BBB.wsdl&amp;dataFormat=MESSAGE" />
			<to uri="xslt:xsl/BBBResponseTransform.xsl" />
			<log message="From BBB ${body}" />							
		</route>

		<route customId="true" id="serviceCCC">
			<from uri="direct:serviceCCC" />
			<to uri="xslt:xsl/CCCRequestTransform.xsl" />		
			<to	uri="cxf:http://localhost:8187/CCC?wsdlURL=wsdl/CCC.wsdl&amp;dataFormat=MESSAGE" />
			<to uri="xslt:xsl/CCCResponseTransform.xsl" />	
			<log message="From CCC ${body}" />							
		</route>

	</camelContext>


</blueprint>